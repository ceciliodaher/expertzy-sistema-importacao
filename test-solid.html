<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Fluxo SOLID</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>Teste do Fluxo Arquitetural SOLID</h1>
        <hr>
        
        <div class="mb-3">
            <button id="btnTestar" class="btn btn-primary btn-lg">
                <i class="bi bi-play-fill"></i> Executar Teste Completo
            </button>
        </div>
        
        <div id="resultados" class="mt-4">
            <!-- Resultados ser√£o inseridos aqui -->
        </div>
    </div>

    <script type="module">
        import DIProcessor from './src/core/processors/DIProcessor.js';
        import { ComplianceCalculator } from './src/core/calculators/ComplianceCalculator.js';
        import { CroquiNFExporter } from './src/core/exporters/CroquiNFExporter.js';
        import IndexedDBManager from './src/services/db/IndexedDBManager.js';
        
        const resultadosDiv = document.getElementById('resultados');
        
        function log(mensagem, tipo = 'info') {
            const classe = tipo === 'error' ? 'danger' : tipo === 'success' ? 'success' : 'info';
            resultadosDiv.innerHTML += `
                <div class="alert alert-${classe}" role="alert">
                    ${mensagem}
                </div>
            `;
        }
        
        async function testarFluxoCompleto() {
            resultadosDiv.innerHTML = '';
            log('<h4>üöÄ Iniciando teste do fluxo completo SOLID...</h4>');
            
            try {
                // 1. CARREGAR E PROCESSAR XML
                log('<strong>üìÑ FASE 1: Processando XML...</strong>');
                
                // Buscar XML de teste
                const response = await fetch('./uploads/2518173187.xml');
                const xmlContent = await response.text();
                
                const diProcessor = new DIProcessor();
                await diProcessor.initialize();
                const dadosDI = await diProcessor.processXML(xmlContent);
                
                if (!dadosDI.numero_di) {
                    throw new Error('N√∫mero da DI n√£o encontrado no XML processado');
                }
                
                log(`‚úÖ XML processado - DI: ${dadosDI.numero_di}`, 'success');
                log(`Adi√ß√µes: ${dadosDI.adicoes.length} | Importador: ${dadosDI.importador.nome}`);
                
                // 2. CALCULAR IMPOSTOS E SALVAR NO INDEXEDDB
                log('<strong>üí∞ FASE 2: Calculando impostos...</strong>');
                
                const calculator = new ComplianceCalculator();
                await calculator.loadConfigurations();
                calculator.setEstadoDestino('SP');
                
                const calculos = await calculator.calcularImpostos(dadosDI);
                
                log(`‚úÖ Impostos calculados e salvos no IndexedDB`, 'success');
                log(`
                    II: R$ ${calculos.impostos.ii.valor_devido.toFixed(2)}<br>
                    IPI: R$ ${calculos.impostos.ipi.valor_devido.toFixed(2)}<br>
                    PIS: R$ ${calculos.impostos.pis.valor_devido.toFixed(2)}<br>
                    COFINS: R$ ${calculos.impostos.cofins.valor_devido.toFixed(2)}<br>
                    ICMS: R$ ${calculos.impostos.icms.valor_devido.toFixed(2)}
                `);
                
                // Verificar se foi salvo no IndexedDB
                const dbManager = IndexedDBManager.getInstance();
                const dadosDB = await dbManager.getDI(dadosDI.numero_di);
                
                if (!dadosDB) {
                    throw new Error('Dados n√£o foram salvos no IndexedDB!');
                }
                
                if (!dadosDB.totais_relatorio) {
                    throw new Error('totais_relatorio n√£o foi salvo no IndexedDB!');
                }
                
                if (!dadosDB.totais_por_coluna) {
                    throw new Error('totais_por_coluna n√£o foi salvo no IndexedDB!');
                }
                
                log(`‚úÖ Dados verificados no IndexedDB`, 'success');
                
                // 3. TESTAR EXPORTADORES (LENDO DO INDEXEDDB)
                log('<strong>üìä FASE 3: Testando exportadores...</strong>');
                
                // Testar CroquiNFExporter
                const croquiExporter = new CroquiNFExporter(dadosDI);
                await croquiExporter.loadCalculatedData();
                
                if (!croquiExporter.calculos || !croquiExporter.calculos.totais_relatorio) {
                    throw new Error('CroquiNFExporter n√£o carregou totais_relatorio do IndexedDB!');
                }
                
                log(`‚úÖ CroquiNFExporter carregou dados do IndexedDB`, 'success');
                
                // Verificar que prepareTotais apenas l√™ dados
                try {
                    const totais = croquiExporter.prepareTotais();
                    log(`‚úÖ prepareTotais() retornou dados pr√©-calculados (n√£o calculou)`, 'success');
                } catch (error) {
                    if (error.message.includes('n√£o encontrados')) {
                        log(`‚úÖ prepareTotais() validou dados obrigat√≥rios corretamente`, 'success');
                    }
                }
                
                // 4. RESUMO FINAL
                log('<hr><h4>üéâ TESTE COMPLETO COM SUCESSO!</h4>', 'success');
                log(`
                    <strong>Arquitetura SOLID aplicada:</strong><br>
                    ‚úÖ ComplianceCalculator calcula e persiste<br>
                    ‚úÖ IndexedDB como √∫nica fonte de verdade<br>
                    ‚úÖ Exportadores apenas leem e formatam<br>
                    ‚úÖ Sem duplica√ß√£o de c√°lculos<br>
                    ‚úÖ Princ√≠pio Single Responsibility respeitado
                `, 'success');
                
            } catch (error) {
                log(`‚ùå ERRO: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        document.getElementById('btnTestar').addEventListener('click', testarFluxoCompleto);
    </script>
</body>
</html>