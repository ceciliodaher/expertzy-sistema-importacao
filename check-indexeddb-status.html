<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîç Status IndexedDB - Sistema Expertzy</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5; 
        }
        .container { 
            max-width: 1000px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .info { color: #007bff; }
        .warning { color: #ffc107; color: #856404; }
        .card { 
            background: #f8f9fa; 
            padding: 15px; 
            margin: 10px 0; 
            border-radius: 5px; 
            border-left: 5px solid #ccc; 
        }
        .card-success { border-left-color: #28a745; }
        .card-error { border-left-color: #dc3545; }
        .card-info { border-left-color: #007bff; }
        .table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 10px 0; 
        }
        .table th, .table td { 
            padding: 8px 12px; 
            border: 1px solid #dee2e6; 
            text-align: left; 
        }
        .table th { 
            background: #e9ecef; 
            font-weight: bold; 
        }
        h1 { color: #333; text-align: center; }
        h2 { color: #495057; border-bottom: 2px solid #dee2e6; padding-bottom: 10px; }
        .json-viewer { 
            background: #2d3748; 
            color: #e2e8f0; 
            padding: 15px; 
            border-radius: 5px; 
            font-family: 'Courier New', monospace; 
            font-size: 12px; 
            max-height: 400px; 
            overflow-y: auto; 
            white-space: pre-wrap; 
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ok { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-error { background-color: #dc3545; }
        .status-empty { background-color: #6c757d; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Status IndexedDB - Sistema Expertzy</h1>
        <p class="info text-center">Diagn√≥stico completo do estado atual do banco de dados IndexedDB</p>
        
        <div id="loading" class="card card-info">
            <h3>‚è≥ Analisando IndexedDB...</h3>
            <p>Verificando conex√£o, schema, dados armazenados e integridade...</p>
        </div>

        <div id="results" style="display: none;">
            <h2>üìä Resumo Executivo</h2>
            <div id="summary"></div>

            <h2>üóÑÔ∏è Schema e Tabelas</h2>
            <div id="schema"></div>

            <h2>üìà Estat√≠sticas de Dados</h2>
            <div id="statistics"></div>

            <h2>üîç Integridade e Estrutura</h2>
            <div id="integrity"></div>

            <h2>üìÑ Dados de Exemplo (√öltima DI)</h2>
            <div id="sampleData"></div>

            <h2>‚ö†Ô∏è Problemas Identificados</h2>
            <div id="issues"></div>
        </div>
    </div>

    <!-- Load Dexie from CDN -->
    <script src="https://unpkg.com/dexie@latest/dist/dexie.js"></script>
    
    <script type="module">
        let analysisResults = {
            dbExists: false,
            tablesCount: 0,
            totalRecords: 0,
            schema: {},
            statistics: {},
            issues: [],
            sampleData: null,
            hasRealData: false
        };

        function addStatusIndicator(status) {
            const indicators = {
                'ok': 'status-ok',
                'warning': 'status-warning', 
                'error': 'status-error',
                'empty': 'status-empty'
            };
            return `<span class="status-indicator ${indicators[status] || 'status-empty'}"></span>`;
        }

        async function analyzeIndexedDB() {
            console.log('üîç Iniciando an√°lise do IndexedDB...');
            
            try {
                // Check if Dexie is available
                if (!window.Dexie) {
                    throw new Error('Dexie.js n√£o est√° dispon√≠vel');
                }

                // Initialize database connection
                const db = new Dexie('ExpertzyDB');
                
                // Try to open and analyze existing database
                const databases = await Dexie.getDatabaseNames();
                console.log('üìã Bancos dispon√≠veis:', databases);
                
                if (!databases.includes('ExpertzyDB')) {
                    analysisResults.issues.push('‚ùå Banco ExpertzyDB n√£o existe');
                    return;
                }

                // Open database and analyze schema
                db.version(1).stores({
                    declaracoes: '++id, numero_di, importador_cnpj, data_processamento, *ncms, xml_hash, xml_content, [importador_cnpj+data_processamento]',
                    adicoes: '++id, di_id, numero_adicao, ncm, [di_id+numero_adicao]',
                    produtos: '++id, adicao_id, codigo, descricao, ncm, valor_unitario, [adicao_id+codigo]',
                    despesas_aduaneiras: '++id, di_id, tipo, valor, codigo_receita, [di_id+tipo]',
                    dados_carga: '++id, di_id, peso_bruto, peso_liquido, via_transporte',
                    incentivos_entrada: '++id, di_id, estado, tipo_beneficio, percentual_reducao, economia_calculada, [di_id+estado]',
                    incentivos_saida: '++id, di_id, estado, operacao, credito_aplicado, contrapartidas, [di_id+estado+operacao]',
                    elegibilidade_ncm: '++id, ncm, estado, incentivo_codigo, elegivel, motivo_rejeicao, [ncm+estado+incentivo_codigo]',
                    metricas_dashboard: '++id, periodo, tipo_metrica, valor, breakdown_estados, [periodo+tipo_metrica]',
                    cenarios_precificacao: '++id, di_id, nome_cenario, configuracao, resultados_comparativos, [di_id+nome_cenario]',
                    historico_operacoes: '++id, timestamp, operacao, modulo, detalhes, resultado',
                    snapshots: '++id, di_id, nome_customizado, timestamp, dados_completos',
                    configuracoes_usuario: 'chave, valor, timestamp, validado'
                });

                await db.open();
                analysisResults.dbExists = true;
                
                // Analyze each table
                const tables = ['declaracoes', 'adicoes', 'produtos', 'despesas_aduaneiras', 'dados_carga', 
                               'incentivos_entrada', 'incentivos_saida', 'elegibilidade_ncm', 'metricas_dashboard',
                               'cenarios_precificacao', 'historico_operacoes', 'snapshots', 'configuracoes_usuario'];
                
                analysisResults.tablesCount = tables.length;
                let totalRecords = 0;

                for (const tableName of tables) {
                    try {
                        const count = await db[tableName].count();
                        analysisResults.statistics[tableName] = count;
                        totalRecords += count;
                        
                        if (count > 0) {
                            console.log(`‚úÖ ${tableName}: ${count} registros`);
                        } else {
                            console.log(`‚ö™ ${tableName}: vazia`);
                        }
                    } catch (error) {
                        console.error(`‚ùå Erro ao analisar ${tableName}:`, error);
                        analysisResults.issues.push(`‚ùå Erro na tabela ${tableName}: ${error.message}`);
                    }
                }
                
                analysisResults.totalRecords = totalRecords;
                analysisResults.hasRealData = totalRecords > 0;
                
                // Get sample data if available
                if (analysisResults.statistics.declaracoes > 0) {
                    try {
                        const lastDI = await db.declaracoes.orderBy('data_processamento').last();
                        analysisResults.sampleData = lastDI;
                        
                        // Get related data
                        if (lastDI) {
                            const adicoes = await db.adicoes.where('di_id').equals(lastDI.id).toArray();
                            analysisResults.sampleData.adicoes = adicoes;
                            console.log(`üìÑ Amostra: DI ${lastDI.numero_di} com ${adicoes.length} adi√ß√µes`);
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao obter dados amostra:', error);
                        analysisResults.issues.push(`‚ùå Erro ao obter amostra: ${error.message}`);
                    }
                }

                // Schema validation
                analysisResults.schema = {
                    version: db.verno,
                    name: db.name,
                    isOpen: db.isOpen(),
                    tables: tables.map(name => ({
                        name,
                        exists: db[name] ? true : false,
                        records: analysisResults.statistics[name] || 0
                    }))
                };

                console.log('‚úÖ An√°lise IndexedDB conclu√≠da');
                
            } catch (error) {
                console.error('‚ùå Erro na an√°lise IndexedDB:', error);
                analysisResults.issues.push(`‚ùå Erro cr√≠tico: ${error.message}`);
            }
        }

        function renderResults() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').style.display = 'block';

            // Summary
            const summaryDiv = document.getElementById('summary');
            const dbStatus = analysisResults.dbExists ? 'ok' : 'error';
            const dataStatus = analysisResults.hasRealData ? 'ok' : 'empty';
            
            summaryDiv.innerHTML = `
                <div class="card card-${dbStatus === 'ok' ? 'success' : 'error'}">
                    <h4>${addStatusIndicator(dbStatus)}Status do Banco</h4>
                    <p><strong>Banco ExpertzyDB:</strong> ${analysisResults.dbExists ? '‚úÖ Conectado' : '‚ùå N√£o encontrado'}</p>
                    <p><strong>Total de Tabelas:</strong> ${analysisResults.tablesCount}</p>
                    <p><strong>Total de Registros:</strong> ${analysisResults.totalRecords}</p>
                    <p><strong>Tem Dados Reais:</strong> ${analysisResults.hasRealData ? '‚úÖ Sim' : '‚ùå Vazio'}</p>
                </div>
            `;

            // Schema
            const schemaDiv = document.getElementById('schema');
            if (analysisResults.schema.tables) {
                const tableRows = analysisResults.schema.tables.map(table => `
                    <tr>
                        <td>${addStatusIndicator(table.exists ? 'ok' : 'error')}${table.name}</td>
                        <td>${table.exists ? '‚úÖ' : '‚ùå'}</td>
                        <td class="${table.records > 0 ? 'success' : ''}">${table.records}</td>
                        <td>${table.records > 0 ? addStatusIndicator('ok') + 'Com dados' : addStatusIndicator('empty') + 'Vazia'}</td>
                    </tr>
                `).join('');
                
                schemaDiv.innerHTML = `
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Tabela</th>
                                <th>Existe</th>
                                <th>Registros</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                `;
            }

            // Statistics
            const statisticsDiv = document.getElementById('statistics');
            const hasMainData = analysisResults.statistics.declaracoes > 0;
            const hasCalculations = analysisResults.statistics.historico_operacoes > 0;
            
            statisticsDiv.innerHTML = `
                <div class="card card-${hasMainData ? 'success' : 'error'}">
                    <h4>${addStatusIndicator(hasMainData ? 'ok' : 'empty')}Dados Principais</h4>
                    <p><strong>Declara√ß√µes:</strong> ${analysisResults.statistics.declaracoes || 0}</p>
                    <p><strong>Adi√ß√µes:</strong> ${analysisResults.statistics.adicoes || 0}</p>
                    <p><strong>Produtos:</strong> ${analysisResults.statistics.produtos || 0}</p>
                    <p><strong>Hist√≥rico Opera√ß√µes:</strong> ${analysisResults.statistics.historico_operacoes || 0}</p>
                </div>
                
                <div class="card card-info">
                    <h4>${addStatusIndicator('info')}Dados Complementares</h4>
                    <p><strong>Despesas Aduaneiras:</strong> ${analysisResults.statistics.despesas_aduaneiras || 0}</p>
                    <p><strong>Dados de Carga:</strong> ${analysisResults.statistics.dados_carga || 0}</p>
                    <p><strong>Configura√ß√µes:</strong> ${analysisResults.statistics.configuracoes_usuario || 0}</p>
                    <p><strong>Snapshots:</strong> ${analysisResults.statistics.snapshots || 0}</p>
                </div>
            `;

            // Integrity
            const integrityDiv = document.getElementById('integrity');
            const hasRelationalIntegrity = analysisResults.statistics.declaracoes > 0 && analysisResults.statistics.adicoes > 0;
            
            integrityDiv.innerHTML = `
                <div class="card card-${hasRelationalIntegrity ? 'success' : 'warning'}">
                    <h4>${addStatusIndicator(hasRelationalIntegrity ? 'ok' : 'warning')}Integridade Relacional</h4>
                    <p><strong>Relacionamento DI ‚Üí Adi√ß√µes:</strong> ${hasRelationalIntegrity ? '‚úÖ √çntegro' : '‚ö†Ô∏è Sem dados para validar'}</p>
                    <p><strong>Schema Version:</strong> ${analysisResults.schema.version || 'N/A'}</p>
                    <p><strong>Conex√£o:</strong> ${analysisResults.schema.isOpen ? '‚úÖ Aberta' : '‚ùå Fechada'}</p>
                </div>
            `;

            // Sample Data
            const sampleDataDiv = document.getElementById('sampleData');
            if (analysisResults.sampleData) {
                sampleDataDiv.innerHTML = `
                    <div class="card card-success">
                        <h4>${addStatusIndicator('ok')}√öltima DI Processada</h4>
                        <p><strong>N√∫mero:</strong> ${analysisResults.sampleData.numero_di}</p>
                        <p><strong>Importador:</strong> ${analysisResults.sampleData.importador_nome || 'N/A'}</p>
                        <p><strong>CNPJ:</strong> ${analysisResults.sampleData.importador_cnpj}</p>
                        <p><strong>Estado:</strong> ${analysisResults.sampleData.importador_endereco_uf}</p>
                        <p><strong>Data Processamento:</strong> ${new Date(analysisResults.sampleData.data_processamento).toLocaleString('pt-BR')}</p>
                        <p><strong>Adi√ß√µes:</strong> ${analysisResults.sampleData.adicoes?.length || 0}</p>
                        <p><strong>NCMs:</strong> ${analysisResults.sampleData.ncms?.length || 0} √∫nicos</p>
                    </div>
                    
                    <h5>üîç Dados Completos (JSON)</h5>
                    <div class="json-viewer">${JSON.stringify(analysisResults.sampleData, null, 2)}</div>
                `;
            } else {
                sampleDataDiv.innerHTML = `
                    <div class="card card-error">
                        <h4>${addStatusIndicator('empty')}Nenhum Dado Dispon√≠vel</h4>
                        <p>N√£o h√° DIs processadas no banco de dados.</p>
                    </div>
                `;
            }

            // Issues
            const issuesDiv = document.getElementById('issues');
            if (analysisResults.issues.length > 0) {
                const issuesList = analysisResults.issues.map(issue => `<li>${issue}</li>`).join('');
                issuesDiv.innerHTML = `
                    <div class="card card-error">
                        <h4>${addStatusIndicator('error')}Problemas Detectados</h4>
                        <ul>${issuesList}</ul>
                    </div>
                `;
            } else {
                issuesDiv.innerHTML = `
                    <div class="card card-success">
                        <h4>${addStatusIndicator('ok')}Sistema Saud√°vel</h4>
                        <p>‚úÖ Nenhum problema detectado na an√°lise.</p>
                    </div>
                `;
            }
        }

        // Run analysis
        window.addEventListener('load', async () => {
            await analyzeIndexedDB();
            renderResults();
        });
    </script>
</body>
</html>