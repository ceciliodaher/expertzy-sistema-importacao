<!DOCTYPE html>
<html>
<head>
    <title>Teste Simples DIProcessor</title>
</head>
<body>
    <h1>Teste DIProcessor</h1>
    <div id="result"></div>
    
    <script type="module">
        try {
            console.log('Iniciando teste...');
            
            // Importar DIProcessor
            const { DIProcessor } = await import('./src/core/processors/DIProcessor.js');
            console.log('DIProcessor importado com sucesso');
            
            // Criar instância
            const processor = new DIProcessor();
            await processor.ensureConfigsLoaded();
            console.log('Configurações carregadas');
            
            // XML de teste mínimo
            const testXML = `<?xml version="1.0" encoding="UTF-8"?>
            <declaracao>
                <adicao>
                    <numeroAdicao>001</numeroAdicao>
                    <tributo>
                        <codigoReceitaImposto>0086</codigoReceitaImposto>
                        <valorImpostoDevido>120000</valorImpostoDevido>
                    </tributo>
                    <tributo>
                        <codigoReceitaImposto>1038</codigoReceitaImposto>
                        <valorImpostoDevido>80000</valorImpostoDevido>
                    </tributo>
                </adicao>
            </declaracao>`;
            
            // Testar extractTributos
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(testXML, "text/xml");
            const adicaoNode = xmlDoc.querySelector('adicao');
            
            const tributos = processor.extractTributos(adicaoNode);
            console.log('Tributos extraídos:', tributos);
            
            // Verificar resultado
            let resultado = '';
            if (Array.isArray(tributos)) {
                resultado += '✅ extractTributos retorna array\n';
                resultado += `✅ ${tributos.length} tributos extraídos\n`;
                
                if (tributos.length > 0 && tributos[0].codigoReceitaImposto) {
                    resultado += '✅ Campos XSD mapeados corretamente\n';
                } else {
                    resultado += '❌ Campos XSD não mapeados\n';
                }
                
                resultado += '\nTributos:\n';
                tributos.forEach((t, i) => {
                    resultado += `${i+1}. Código: ${t.codigoReceitaImposto}, Valor: ${t.valorImpostoDevido}\n`;
                });
            } else {
                resultado += '❌ extractTributos não retorna array\n';
            }
            
            // Testar NO FALLBACKS
            resultado += '\n--- Teste NO FALLBACKS ---\n';
            try {
                const xmlSemCodigo = `<adicao><tributo><valorImpostoDevido>120000</valorImpostoDevido></tributo></adicao>`;
                const xmlDoc2 = parser.parseFromString(xmlSemCodigo, "text/xml");
                const adicaoNode2 = xmlDoc2.querySelector('adicao');
                processor.extractTributos(adicaoNode2);
                resultado += '❌ Deveria ter falhado com NO FALLBACKS\n';
            } catch (error) {
                resultado += '✅ NO FALLBACKS funcionando: ' + error.message + '\n';
            }
            
            document.getElementById('result').innerHTML = '<pre>' + resultado + '</pre>';
            console.log('Teste concluído com sucesso');
            
        } catch (error) {
            console.error('Erro no teste:', error);
            document.getElementById('result').innerHTML = '<pre style="color: red;">❌ Erro: ' + error.message + '</pre>';
        }
    </script>
</body>
</html>