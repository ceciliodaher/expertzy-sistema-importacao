<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Cr√≠tico - Fix Incoterm</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; overflow: auto; max-height: 400px; }
    </style>
</head>
<body>
    <h1>üö® Teste Cr√≠tico - Fix do Bug Incoterm</h1>
    
    <div>
        <h2>Teste: Processamento DI Completo</h2>
        <button onclick="testCompleteProcessing()">Testar Processamento Completo</button>
        <div id="result"></div>
    </div>

    <script type="module">
        import { DIProcessor } from './src/core/processors/DIProcessor.js';

        window.diProcessor = new DIProcessor();

        // XML com estrutura realista similar aos erros de produ√ß√£o
        window.testXML = `<?xml version="1.0" encoding="UTF-8"?>
        <declaracaoImportacao>
            <identificacaoDeclaracaoImportacao>12345678901234567890</identificacaoDeclaracaoImportacao>
            <numeroImportador>12345678000123</numeroImportador>
            <nomeImportador>EMPRESA TESTE LTDA</nomeImportador>
            <enderecoUfImportador>SP</enderecoUfImportador>
            
            <adicao>
                <numeroAdicao>001</numeroAdicao>
                <codigoMercadoriaNCM>84439990</codigoMercadoriaNCM>
                <codigoIncotermsVenda>FOB</codigoIncotermsVenda>
                <valorMercadoriaEmbarqueMoedaNacional>10000.00</valorMercadoriaEmbarqueMoedaNacional>
                <valorMercadoriaCondicaoVenda>8000.00</valorMercadoriaCondicaoVenda>
                <valorFreteMercadoriaMoedaNacional>500.00</valorFreteMercadoriaMoedaNacional>
                <valorSeguroMercadoriaMoedaNacional>200.00</valorSeguroMercadoriaMoedaNacional>
                
                <tributo>
                    <codigoReceitaImposto>0086</codigoReceitaImposto>
                    <percentualAliquotaNormalAdval>1400</percentualAliquotaNormalAdval>
                    <valorImpostoDevido>1120.00</valorImpostoDevido>
                    <valorBaseCalculoAdval>8000.00</valorBaseCalculoAdval>
                </tributo>
                <tributo>
                    <codigoReceitaImposto>1038</codigoReceitaImposto>
                    <percentualAliquotaNormalAdval>1000</percentualAliquotaNormalAdval>
                    <valorImpostoDevido>938.00</valorImpostoDevido>
                    <valorBaseCalculoAdval>9380.00</valorBaseCalculoAdval>
                </tributo>
                <tributo>
                    <codigoReceitaImposto>5110</codigoReceitaImposto>
                    <percentualAliquotaNormalAdval>165</percentualAliquotaNormalAdval>
                    <valorImpostoDevido>154.77</valorImpostoDevido>
                    <valorBaseCalculoAdval>9380.00</valorBaseCalculoAdval>
                </tributo>
                <tributo>
                    <codigoReceitaImposto>5505</codigoReceitaImposto>
                    <percentualAliquotaNormalAdval>760</percentualAliquotaNormalAdval>
                    <valorImpostoDevido>712.88</valorImpostoDevido>
                    <valorBaseCalculoAdval>9380.00</valorBaseCalculoAdval>
                </tributo>

                <mercadoria>
                    <numeroSequencialItem>001</numeroSequencialItem>
                    <textoDetalhamentoMercadoria>COMPONENTE ELETR√îNICO</textoDetalhamentoMercadoria>
                    <quantidadeMercadoriaUnidadeComercializada>100.00</quantidadeMercadoriaUnidadeComercializada>
                    <nomeUnidadeMedidaComercializada>UNIDADES</nomeUnidadeMedidaComercializada>
                    <valorUnidadeMedidaCondicaoVenda>80.00</valorUnidadeMedidaCondicaoVenda>
                </mercadoria>
            </adicao>
        </declaracaoImportacao>`;

        window.testCompleteProcessing = async function() {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '<div class="info">üîÑ Processando DI completa...</div>';
            
            try {
                console.log('üöÄ Iniciando teste cr√≠tico do fix incoterm...');
                
                // Processar XML completo
                const diData = await window.diProcessor.parseXML(window.testXML);
                
                let html = '<div class="success">‚úÖ SUCESSO! Bug incoterm corrigido!</div>';
                html += '<div class="info">DI processada sem erros</div>';
                html += `<div class="info">üìä Resultado processamento:</div>`;
                html += `<div>- N√∫mero DI: ${diData.identificacao_declaracao_importacao}</div>`;
                html += `<div>- Importador: ${diData.importador.nome}</div>`;
                html += `<div>- Total adi√ß√µes: ${diData.adicoes.length}</div>`;
                
                if (diData.adicoes.length > 0) {
                    const adicao = diData.adicoes[0];
                    html += `<div>- Incoterm adi√ß√£o 001: ${adicao.condicao_venda_incoterm}</div>`;
                    html += `<div>- Tributos adi√ß√£o 001: ${adicao.tributos.length}</div>`;
                    html += `<div>- Produtos adi√ß√£o 001: ${adicao.produtos.length}</div>`;
                    
                    if (adicao.produtos.length > 0) {
                        const produto = adicao.produtos[0];
                        html += `<div>- Frete rateado: R$ ${produto.frete_rateado_brl?.toFixed(2) || 'N/A'}</div>`;
                        html += `<div>- Seguro rateado: R$ ${produto.seguro_rateado_brl?.toFixed(2) || 'N/A'}</div>`;
                    }
                }
                
                html += '<h3>üéØ Campos cr√≠ticos validados:</h3>';
                html += '<div class="success">‚úÖ Campo condicao_venda_incoterm criado corretamente</div>';
                html += '<div class="success">‚úÖ M√©todo ratearFreteSeguroPorItens usa campo correto</div>';
                html += '<div class="success">‚úÖ Nenhum erro "Incoterm obrigat√≥rio ausente"</div>';
                
                html += '<h3>üìã Dados processados:</h3>';
                html += '<pre>' + JSON.stringify(diData, null, 2) + '</pre>';
                
                resultDiv.innerHTML = html;
                
                console.log('‚úÖ Teste cr√≠tico PASSOU! Bug incoterm corrigido com sucesso.');
                
            } catch (error) {
                console.error('‚ùå FALHOU! Bug incoterm ainda presente:', error);
                
                let html = '<div class="error">‚ùå FALHA! Bug ainda presente</div>';
                html += `<div class="error">Erro: ${error.message}</div>`;
                html += '<div class="error">Stack:</div>';
                html += '<pre>' + error.stack + '</pre>';
                
                resultDiv.innerHTML = html;
            }
        };

        // Auto-executar o teste
        window.addEventListener('load', function() {
            setTimeout(() => {
                window.testCompleteProcessing();
            }, 1000);
        });
    </script>
</body>
</html>