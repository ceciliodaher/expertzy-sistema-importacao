<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verificação Manual IndexedDB - Expertzy</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; font-family: monospace; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; font-size: 16px; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 Verificação Manual - IndexedDB</h1>
        <p>Esta página verifica se os dados estão sendo corretamente armazenados no IndexedDB após processamento do XML.</p>
        
        <div class="controls">
            <button onclick="checkDatabase()">🔍 Verificar IndexedDB</button>
            <button onclick="clearDatabase()">🗑️ Limpar IndexedDB</button>
            <button onclick="showSchema()">📋 Ver Schema</button>
        </div>
        
        <div id="results"></div>
        
        <h2>📊 Dados Encontrados</h2>
        <div id="data-display"></div>
    </div>

    <script>
        function log(message, type = 'info') {
            const results = document.getElementById('results');
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            results.appendChild(logDiv);
            console.log(message);
        }

        async function checkDatabase() {
            log('🚀 Iniciando verificação do IndexedDB...');
            
            try {
                const request = indexedDB.open('ExpertzyDB');
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    log(`✅ Database encontrado: ${db.name} (versão ${db.version})`, 'success');
                    
                    // Listar object stores
                    const storeNames = Array.from(db.objectStoreNames);
                    log(`📋 Object Stores: ${storeNames.join(', ')}`);
                    
                    // Verificar cada tabela
                    checkAllTables(db);
                };
                
                request.onerror = () => {
                    log('❌ Erro ao abrir IndexedDB', 'error');
                };
                
                request.onupgradeneeded = () => {
                    log('⚠️ Database não existe ou precisa de upgrade', 'warning');
                };
                
            } catch (error) {
                log(`❌ Erro: ${error.message}`, 'error');
            }
        }
        
        async function checkAllTables(db) {
            const tables = ['declaracoes', 'adicoes', 'produtos', 'despesas_aduaneiras'];
            const dataDisplay = document.getElementById('data-display');
            dataDisplay.innerHTML = '';
            
            for (const tableName of tables) {
                if (db.objectStoreNames.contains(tableName)) {
                    await checkTable(db, tableName);
                } else {
                    log(`⚠️ Tabela ${tableName} não encontrada`, 'warning');
                }
            }
        }
        
        function checkTable(db, tableName) {
            return new Promise((resolve) => {
                const transaction = db.transaction([tableName], 'readonly');
                const store = transaction.objectStore(tableName);
                const request = store.getAll();
                
                request.onsuccess = () => {
                    const data = request.result;
                    log(`📊 ${tableName}: ${data.length} registros encontrados`);
                    
                    if (data.length > 0) {
                        displayTableData(tableName, data);
                        
                        // Log detalhado para declaracoes
                        if (tableName === 'declaracoes') {
                            data.forEach((di, index) => {
                                log(`📋 DI ${index + 1}: ${di.numero_di} - ${di.importador_nome} (${di.importador_cnpj})`);
                            });
                        }
                        
                        // Log detalhado para adicoes
                        if (tableName === 'adicoes') {
                            data.forEach((adicao, index) => {
                                log(`📦 Adição ${index + 1}: ${adicao.numero_adicao} - NCM ${adicao.ncm} - R$ ${adicao.valor_reais?.toFixed(2)}`);
                            });
                        }
                    }
                    resolve();
                };
                
                request.onerror = () => {
                    log(`❌ Erro ao ler tabela ${tableName}`, 'error');
                    resolve();
                };
            });
        }
        
        function displayTableData(tableName, data) {
            const dataDisplay = document.getElementById('data-display');
            
            const section = document.createElement('div');
            section.innerHTML = `<h3>📋 ${tableName} (${data.length} registros)</h3>`;
            
            if (data.length > 0) {
                const table = document.createElement('table');
                const firstItem = data[0];
                const keys = Object.keys(firstItem).slice(0, 5); // Primeiras 5 colunas
                
                // Header
                const headerRow = table.insertRow();
                keys.forEach(key => {
                    const th = document.createElement('th');
                    th.textContent = key;
                    headerRow.appendChild(th);
                });
                
                // Data rows (máximo 3)
                data.slice(0, 3).forEach(item => {
                    const row = table.insertRow();
                    keys.forEach(key => {
                        const cell = row.insertCell();
                        const value = item[key];
                        if (typeof value === 'object' && value !== null) {
                            cell.textContent = JSON.stringify(value).substring(0, 50) + '...';
                        } else {
                            cell.textContent = value || '';
                        }
                    });
                });
                
                section.appendChild(table);
            }
            
            dataDisplay.appendChild(section);
        }
        
        async function clearDatabase() {
            log('🗑️ Limpando IndexedDB...');
            
            const deleteReq = indexedDB.deleteDatabase('ExpertzyDB');
            deleteReq.onsuccess = () => {
                log('✅ Database limpo com sucesso', 'success');
                document.getElementById('data-display').innerHTML = '';
            };
            deleteReq.onerror = () => {
                log('❌ Erro ao limpar database', 'error');
            };
        }
        
        function showSchema() {
            log('📋 Schema IndexedDB v2:');
            log('• declaracoes: id, numero_di, importador_cnpj, importador_nome, data_registro');
            log('• adicoes: id, di_id, numero_adicao, ncm, valor_reais, tributos');
            log('• produtos: id, adicao_id, codigo, descricao, valor_unitario');
            log('• despesas_aduaneiras: id, di_id, tipo, valor, codigo_receita');
        }
        
        // Auto-check ao carregar
        window.onload = () => {
            log('📱 Página carregada. Clique em "Verificar IndexedDB" para começar.');
        };
    </script>
</body>
</html>